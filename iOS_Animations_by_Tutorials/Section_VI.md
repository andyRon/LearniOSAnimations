# ç³»ç»Ÿå­¦ä¹ iOSåŠ¨ç”»ä¹‹å…­ï¼š3DåŠ¨ç”»



åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¹‹å‰çš„æ–‡ç« åªä½¿ç”¨äº†äºŒç»´åŠ¨ç”»â€”â€”è¿™æ˜¯åœ¨å¹³é¢è®¾å¤‡å±å¹•ä¸ŠåŠ¨ç”»å…ƒç´ çš„æœ€è‡ªç„¶æ–¹å¼ã€‚ æ¯•ç«Ÿï¼Œä»iOS 7æ‰å¹³åŒ–åçš„ä¸–ç•Œä¸­çš„æŒ‰é’®ï¼Œæ–‡æœ¬å­—æ®µï¼Œå¼€å…³å’Œå›¾åƒæ²¡æœ‰äº†ç¬¬ä¸‰ç»´; è¿™äº›å…ƒç´ å­˜åœ¨äºç”±Xå’ŒYè½´å®šä¹‰çš„å¹³é¢ä¸­ï¼š

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fx962j0d7jj309a03g0sj.jpg)

**æ ¸å¿ƒåŠ¨ç”»**å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‘†è„±è¿™ä¸ªäºŒç»´ä¸–ç•Œ; è™½ç„¶å®ƒä¸æ˜¯çœŸæ­£çš„3Dæ¡†æ¶ï¼Œä½†**æ ¸å¿ƒåŠ¨ç”»**æœ‰å¾ˆå¤šå¥½çš„æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨3Dç©ºé—´ä¸­æç»˜äºŒç»´å¯¹è±¡ã€‚

æ¢å¥è¯è¯´ï¼Œå›¾å±‚å’ŒåŠ¨ç”»ä»ç„¶ä»¥äºŒç»´æ–¹å¼è¿›è¡Œæç»˜ï¼Œä½†å¯ä»¥åœ¨3Dç©ºé—´ä¸­æ—‹è½¬å’Œå®šä½æ¯ä¸ªå…ƒç´ çš„2Då¹³é¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fx9630g50tj30ab04jdfv.jpg)

ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯åœ¨3Dç©ºé—´ä¸­æ—‹è½¬çš„ä¸¤ä¸ª2Då›¾åƒã€‚ é€è§†å˜å½¢ä½¿æˆ‘ä»¬å¯ä»¥ä»æ¸²æŸ“å™¨çš„è§’åº¦äº†è§£å®ƒä»¬çš„ä½ç½®ã€‚

æœ¬æ–‡å°†å­¦ä¹ å¦‚ä½•åœ¨3Dç©ºé—´ä¸­å®šä½å’Œæ—‹è½¬å›¾å±‚ã€‚`CATransform3D`ç±»ä¼¼äº`CGAffineTransform`ï¼Œä½†é™¤äº†åœ¨xå’Œyæ–¹å‘ä¸Šç¼©æ”¾ï¼Œå€¾æ–œå’Œå¹³ç§»ä¹‹å¤–ï¼Œå®ƒè¿˜å¸¦æ¥äº†ç¬¬ä¸‰ç»´ï¼šzã€‚ zè½´ç›´æ¥ä»è®¾å¤‡å±å¹•æœå‘æ‚¨çš„çœ¼ç›ã€‚

è¯·è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªç¤ºä¾‹ï¼Œä»¥æ›´å¥½åœ°äº†è§£é€è§†çš„å·¥ä½œåŸç†ã€‚

å°†ç›¸æœºè®¾ç½®å¾—éå¸¸é è¿‘å±å¹•ä¼šç›¸åº”åœ°æ‰­æ›²å›¾å±‚çš„è§†è§’ï¼š

![image-20181204230708868](https://ws1.sinaimg.cn/large/006tNbRwgy1fxv44v769fj30b60a4jsk.jpg)

å¦‚æœå°†ç›¸æœºç¦»ç‰©ä½“æ¯”è¾ƒè¿œæ—¶çš„è§†è§’ï¼š

![image-20181204230723724](https://ws2.sinaimg.cn/large/006tNbRwgy1fxv45b8kb6j309s0anwfo.jpg)

æœ€åï¼Œå¦‚æœä½ åœ¨ç›¸æœºå’Œå±å¹•ä¹‹é—´è®¾ç½®äº†å¾ˆå¤§çš„è·ç¦»ï¼š

![image-20181204230830029](https://ws2.sinaimg.cn/large/006tNbRwgy1fxv469w6efj309508kq3v.jpg)



[24-ç®€å•çš„3DåŠ¨ç”»](#24-ç®€å•3DåŠ¨ç”») â€”â€” å°è¯•æ–°å‘ç°çš„æœ‰å…³ç›¸æœºè·ç¦»å’Œè§†è§’çš„çŸ¥è¯†ã€‚è®¾ç½®å›¾å±‚çš„é€è§†å›¾ï¼Œå¤„ç†å›¾å±‚çš„å˜æ¢ä»¥æ—‹è½¬ï¼Œå¹³ç§»å’Œç¼©æ”¾ä¸‰ç»´å›¾å±‚ã€‚

[25-ä¸­çº§3DåŠ¨ç”»](#25-ä¸­çº§3DåŠ¨ç”») â€”â€” åœ¨å‰ä¸€ç« çš„åŸºç¡€ä¸Šï¼Œæ—¢ç„¶ä½ çŸ¥é“äº†m34å’Œç›¸æœºè·ç¦»çš„ç§˜å¯†ï¼Œä½ å°±å¯ä»¥åˆ›å»ºå…·æœ‰å¤šä¸ªè§†å›¾çš„å„ç§3DåŠ¨ç”»ã€‚



## 24-ç®€å•3DåŠ¨ç”»



æœ¬ç« å°†å°æ–°å‘ç°çš„æœ‰å…³ç›¸æœºè·ç¦»å’Œè§†è§’çš„çŸ¥è¯†ã€‚

å¼€å§‹é¡¹ç›® [Office Buddy](README.md#å…³äºä»£ç )æ˜¯ä¸€ä¸ªåŠå…¬å®¤å¸®åŠ©åº”ç”¨ç¨‹åºï¼Œä¾›å‘˜å·¥è®¿é—®æœ‰å…³æ—¥å¸¸å…¬å¸ç”Ÿæ´»çš„åˆ†ç±»ä¿¡æ¯ã€‚è¿™ä¸ªåº”ç”¨å¾ˆç®€å•å°±æ˜¯ç‚¹å‡»å·¦ä¸Šè§’çš„æŒ‰é’®æˆ–è€…å·¦å³æ»‘åˆ°ï¼Œç„¶åå·¦è¾¹ä¾§æ å‡ºç°ã€‚ä¸‹é¢ğŸ‘‡å°†å‘è¿™ä¸ªå¼€å§‹é¡¹ç›®ä¸­æ·»åŠ ä¸€äº›3Då…ƒç´ ã€‚

å¼€å§‹é¡¹ç›®é¢„è§ˆï¼š

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxv4fvitbsg308q0fntd3.gif)



### åˆ›é€ 3Dtransformations



æ‰“å¼€`ContainerViewController.swift`ï¼Œ`ContainerViewController`åœ¨å±å¹•ä¸Šæ˜¾ç¤ºèœå•è§†å›¾æ§åˆ¶å™¨å’Œå†…å®¹è§†å›¾æ§åˆ¶å™¨ã€‚ å®ƒè¿˜å¤„ç†å¹³ç§»æ‰‹åŠ¿ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥æ‰“å¼€å’Œå…³é—­èœå•ã€‚

æ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯æ„å»ºä¸€ä¸ªç±»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºä¾§é¢èœå•çš„ç»™å®šç™¾åˆ†æ¯”â€œå¼€æ”¾æ€§â€åˆ›å»ºç›¸åº”çš„3Då˜æ¢ã€‚
å°†ä»¥ä¸‹æ–¹æ³•å£°æ˜æ·»åŠ åˆ°`ContainerViewController`ï¼š

```swift
func menuTransform(percent: CGFloat) -> CATransform3D {

}
```

ä¸Šè¿°æ–¹æ³•æ¥å—èœå•å½“å‰è¿›åº¦çš„å•ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°ç”±`handleGesture(_ :)`ä¸­çš„ä»£ç è®¡ç®—ï¼Œå¹¶è¿”å›`CATransform3D`çš„å®ä¾‹ã€‚ æ‚¨å°†ç›´æ¥å°†æ­¤æ–¹æ³•çš„ç»“æœåˆ†é…ç»™èœå•å›¾å±‚çš„transformå±æ€§ã€‚

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°ä¸Šé¢æ–¹æ³•ä¸­ï¼š

```swift
var identity = CATransform3DIdentity
identity.m34 = -1.0/1000
```

è¿™æ®µä»£ç å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹ä»¤äººæƒŠè®¶; åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨åªä½¿ç”¨å‡½æ•°æ¥åˆ›å»ºæˆ–ä¿®æ”¹å˜æ¢ã€‚ ä½†æ˜¯ï¼Œè¿™ä¸€æ¬¡ï¼Œæ‚¨æ­£åœ¨ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªç±»çš„å±æ€§ã€‚

>  æ³¨æ„ï¼š`CATransform3D`å’Œ`CGAffineTransform`åˆ†è¡¨è¡¨ç¤º`4*4`å’Œ`3*3`çš„æ•°å­¦[çŸ©é˜µ](https://zh.wikipedia.org/wiki/çŸ©é˜µ)ï¼Œåœ¨Swiftå’ŒOCä¸­éƒ½æ˜¯ç”¨ç»“æ„ä½“è¡¨ç¤ºçš„ã€‚
>
>  å±æ€§`m34`æŒ‡çŸ©é˜µçš„ç¬¬3è¡Œç¬¬4åˆ—ï¼Œè¿™ä¸ªå±æ€§æ¯”è¾ƒå¸¸ç”¨ï¼Œè¡¨ç¤ºé€è§†æ•ˆæœï¼Œ`m34 = -1 / D`ï¼ŒDå¯ä»¥ç†è§£ä¸º**ç›¸æœºè·ç¦»**ï¼ŒDè¶Šå°ï¼Œé€è§†æ•ˆæœè¶Šæ˜æ˜¾ï¼Œå¿…é¡»åœ¨æœ‰æ—‹è½¬æ•ˆæœçš„å‰æä¸‹ï¼Œæ‰ä¼šçœ‹åˆ°é€è§†æ•ˆæœã€‚



### ç›¸æœºè·ç¦» 

å¯¹äºæ™®é€šåº”ç”¨ç¨‹åºä¸­çš„UIå…ƒç´ ï¼Œç›¸æœºè·ç¦»å¤§æ¦‚å¯ä»¥è¡¨ç¤ºï¼š
*0.1 ... 500*ï¼šéå¸¸æ¥è¿‘ï¼Œé€è§†å¤±çœŸã€‚
*750 ... 2,000*ï¼šè§†è§’ä¸é”™ï¼Œå†…å®¹æ¸…æ™°å¯è§ã€‚
*2000+*ï¼šå‡ ä¹æ²¡æœ‰é€è§†å¤±çœŸã€‚

å¯¹äºOffice Buddyåº”ç”¨ç¨‹åºï¼Œ1000ç‚¹çš„è·ç¦»å°†ä¸ºèœå•æä¾›ä¸€ä¸ªéå¸¸å¾®å¦™çš„è§†è§’ã€‚ 

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`menuTransform(percent:)`çš„åº•éƒ¨ï¼š

```swift
let remainingPercent = 1.0 - percent
let angle = remainingPercent * .pi * -0.5
```

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`menuTransform(percent:)`çš„åº•éƒ¨ï¼š

```swift
let rotationTransform = CATransform3DRotate(identity, angle, 0.0, 1.0, 0.0)
let translationTransform = CATransform3DMakeTranslation(menuWidth * percent, 0, 0)
return CATransform3DConcat(rotationTransform, translationTransform)
```

åœ¨è¿™é‡Œï¼Œä½¿ç”¨`rotationTransform`å°†å›¾å±‚ç»•yè½´æ—‹è½¬ã€‚ èœå•ä»å·¦ä¾§ç§»åŠ¨ï¼Œå› æ­¤è¿˜éœ€è¦åˆ›å»ºå¹³ç§»å˜æ¢ä»¥æ²¿xè½´ç§»åŠ¨å®ƒï¼Œæœ€ç»ˆå°†èœå•å®½åº¦è®¾ç½®ä¸º100ï¼…ã€‚ æœ€åï¼Œè¿æ¥ä¸¤ä¸ªè½¬æ¢å¹¶è¿”å›ç»“æœã€‚



ä»`setMenu(toPercent:)`ä¸­åˆ é™¤ä¸‹é¢ï¼š

```swift
menuViewController.view.frame.origin.x = menuWidth * CGFloat(percent) - menuWidth
```

æ›¿ä»£ä¸ºï¼š 

```swift
menuViewController.view.layer.transform = menuTransform(percent: percent)
```

èœå•æ çš„ä½ç½®é€šè¿‡è½¬æ¢æ¥æ§åˆ¶äº†ã€‚



è¿è¡Œé¡¹ç›®ï¼Œ å‘å³å¹³ç§»æŸ¥çœ‹èœå•å¦‚ä½•å›´ç»•å…¶yè½´æ—‹è½¬ï¼š

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fxvodwgodgg306y08edhk.gif)

èœå•ä»¥3Då½¢å¼æ—‹è½¬ï¼Œä½†å®ƒå›´ç»•å…¶æ°´å¹³ä¸­å¿ƒæ—‹è½¬ï¼Œèœå•ä¸å†…å®¹è§†å›¾æ§åˆ¶å™¨ä¸­é—´æœ‰é—´éš™ã€‚



### ç§»åŠ¨å›¾å±‚çš„é”šç‚¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾å±‚çš„é”šç‚¹çš„xåæ ‡ä¸º0.5ï¼Œè¡¨ç¤ºå®ƒä½äºä¸­å¿ƒã€‚ å°†é”šç‚¹çš„xè®¾ç½®ä¸º1.0ï¼Œå°±ä¸ä¼šå‡ºç°ä¸Šé¢çš„é‚£ç§é—´éš™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
![image-20181205104831488](https://ws1.sinaimg.cn/large/006tNbRwgy1fxvoenmznij30a207xq3b.jpg)



æ‰€æœ‰å˜æ¢éƒ½æ˜¯å›´ç»•å›¾å±‚çš„é”šç‚¹è®¡ç®—çš„ã€‚

åœ¨`viewDidLoad()`ä¸­æ‰¾åˆ°ä»¥ä¸‹è¡Œï¼š

```swift
menuViewController.view.frame = CGRect(x: -menuWidth, y: 0, width: menuWidth, height: view.frame.height)
```

ç°åœ¨åœ¨è¯¥è¡Œä¸Šæ–¹æ’å…¥ä»¥ä¸‹ä»£ç ï¼ˆåœ¨è®¾ç½®è§†å›¾å¸§ä¹‹å‰æ’å…¥è¡Œéå¸¸é‡è¦ï¼Œå¦åˆ™è®¾ç½®é”šç‚¹å°†åç§»è§†å›¾ï¼‰ï¼š

```swift
menuViewController.view.layer.anchorPoint.x = 1.0
```

è¿™ä¼šä½¿èœå•å›´ç»•å…¶å³è¾¹ç¼˜æ—‹è½¬ã€‚

è¿è¡Œæ•ˆæœï¼š

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxvokxjjzcg306y08e764.gif)

è¿™çœ‹èµ·æ¥å¥½å¤šäº†ï¼


### é€šè¿‡é˜´å½±åˆ›å»ºè¿œæ™¯

é˜´å½±ä¸º3DåŠ¨ç”»å¸¦æ¥äº†å¾ˆå¤šçœŸå®æ„Ÿã€‚è¿™é‡Œä¸éœ€è¦ä½¿ç”¨ä»»ä½•å…ˆè¿›çš„ç€è‰²æŠ€æœ¯ï¼Œåªè¦æ—‹è½¬æ—¶æ›´æ”¹`alpha`ã€‚

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`setMenu(toPercent:)`ï¼š

```swift
menuViewController.view.alpha = CGFloat(max(0.2, percent))
```

0.2è®©èœå•æœ€å°è¿˜å¯è§ï¼Œç™¾åˆ†æ¯”è®©èœå•è¶Šå°é€æ˜åº¦è¶Šä½ã€‚

ç”±äºæ­¤åº”ç”¨ç¨‹åºçš„èƒŒæ™¯ä¸ºé»‘è‰²ï¼Œå› æ­¤é™ä½èœå•è§†å›¾çš„alphaå€¼ä¼šä½¿èœå•ä¸­æ˜¾ç¤ºé»‘è‰²å¹¶æ¨¡æ‹Ÿé˜´å½±æ•ˆæœã€‚

è¿è¡Œæ•ˆæœï¼š

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxvoq48apag306y08edhu.gif)

è¿™æ˜¯ä¸€ä¸ªè®©3Dæ•ˆæœæ›´åŠ çœŸå®çš„å°ç»†èŠ‚ã€‚



å¦‚æœä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°ç¬¬ä¸€æ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œèœå•ä¸æ˜¯ä»¥3Dæ•ˆæœå±•ç¤ºï¼Œä»¥åæ‰æ˜¯ã€‚è¿™æ˜¯å› ä¸ºç¬¬ä¸€æ¬¡åˆ‡æ¢èœå•ä¹‹å‰ï¼Œè®¾ç½®3DåŠ¨ç”»å‚æ•°å’Œå›¾å±‚è½¬æ¢ã€‚åœ¨`viewDidLoad()`ä¸­æ·»åŠ ï¼š

```swift
setMenu(toPercent: 0.0)
```



### å…‰æ …åŒ–çš„æ•ˆç‡

è®©åŠ¨ç”»æ›´åŠ â€œå®Œç¾â€ã€‚å¦‚æœåœ¨æ¥å›å¹³ç§»æ—¶ç›¯ç€èœå•è¶³å¤Ÿé•¿ï¼Œä¼šæ³¨æ„åˆ°èœå•é¡¹çš„è¾¹æ¡†çœ‹èµ·æ¥åƒç´ åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20181205110350367](https://ws3.sinaimg.cn/large/006tNbRwgy1fxvoukq8jyj30b706tmxa.jpg)

æ ¸å¿ƒåŠ¨ç”»ä¸æ–­é‡ç»˜èœå•è§†å›¾æ§åˆ¶å™¨çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶åœ¨æ‰€æœ‰å…ƒç´ ç§»åŠ¨æ—¶é‡æ–°è®¡ç®—æ‰€æœ‰å…ƒç´ çš„é€è§†å¤±çœŸï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå‡ºç°*é”¯é½¿çŠ¶è¾¹ç¼˜*ã€‚

æœ€å¥½è®©Core AnimationçŸ¥é“æˆ‘ä»¬ä¸ä¼šåœ¨åŠ¨ç”»æœŸé—´æ›´æ”¹èœå•å†…å®¹ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¸²æŸ“èœå•ä¸€æ¬¡å¹¶ç®€å•åœ°æ—‹è½¬æ¸²æŸ“å’Œç¼“å­˜çš„å›¾åƒã€‚
è¿™å¬èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†å¾ˆå®¹æ˜“å®ç°ã€‚

æ‰¾åˆ°`handleGesture()`ä¸­çš„`.began`ä»£ç å—ï¼Œæ­¤ä»£ç åœ¨ç”¨æˆ·å¹³ç§»æ“ä½œæ—¶æ‰§è¡Œã€‚

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`.began`ä»£ç å—çš„æœ«å°¾ï¼š

```swift
menuViewController.view.layer.shouldRasterize = true
menuViewController.view.layer.rasterizationScale = UIScreen.main.scale
```

`shouldRasterize`è®©æ ¸å¿ƒåŠ¨ç”»å°†å›¾å±‚å†…å®¹ç¼“å­˜ä¸ºå›¾åƒã€‚ ç„¶åè®¾ç½®`rasterizationScale`ä»¥åŒ¹é…å½“å‰çš„å±å¹•æ¯”ä¾‹ã€‚

è¿è¡Œï¼Œæ•ˆæœï¼š

![image-20181205110814153](https://ws2.sinaimg.cn/large/006tNbRwgy1fxvoz544nmj308203uwed.jpg)

ä¸ºé¿å…åœ¨ä½¿ç”¨åº”ç”¨ç¨‹åºæ—¶è¿›è¡Œä»»ä½•ä¸å¿…è¦çš„ç¼“å­˜ï¼Œåº”è¯¥åœ¨åŠ¨ç”»å®Œæˆåç«‹å³å…³é—­å…‰æ …åŒ–ã€‚
åœ¨`.failed`ä»£ç å—æ‰¾åˆ°åŠ¨ç”»å®Œæˆé—­åŒ…å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```swift
self.menuViewController.view.layer.shouldRasterize = false
```

ç°åœ¨ï¼Œåªåœ¨åŠ¨ç”»æœŸé—´æ¿€æ´»å…‰æ …åŒ–ã€‚æé«˜äº†æ•ˆç‡ï¼ğŸ˜Š



### èœå•æŒ‰é’®çš„3Dæ—‹è½¬åŠ¨ç”»

èœå•å±•ç¤ºæ—¶ï¼Œèœå•æŒ‰é’®ä¹Ÿè¿›è¡Œè‡ªèº«çš„æ—‹è½¬ã€‚å…·ä½“æ¥è¯´ï¼Œæ‚¨å°†å›´ç»•xè½´å’Œyè½´åˆ›å»ºæ—‹è½¬ï¼Œä»¥ä½¿èœå•æŒ‰é’®åœ¨å…¶å¯¹è§’çº¿ä¸Šç¿»è½¬ã€‚

åœ¨`ContainerViewController`çš„`setMenu(toPercent:)`ä¸­æ·»åŠ ï¼š

```swift
let centerVC = centerViewController.viewControllers.first as? CenterViewController
if let menuButton = centerVC?.menuButton {
    menuButton.imageView.layer.transform = buttonTransform(percent: percent)
}
```

`buttonTransform`å‡½æ•°ä¸ºï¼š

```swift
func buttonTransform(percent: CGFloat) -> CATransform3D {
    var identity = CATransform3DIdentity
    identity.m34 = -1.0/1000

    let angle = percent * .pi
    let rotationTransform = CATransform3DRotate(identity, angle, 1.0, 1.0, 0.0)

    return rotationTransform
}
```


æ•ˆæœå¦‚ä¸‹ï¼š

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxvpgah492g306y067799.gif)





## 25-ä¸­çº§3DåŠ¨ç”»

åœ¨ä¸Šä¸€ç« [24-ç®€å•3DåŠ¨ç”»](#24-ç®€å•3DåŠ¨ç”»)ä¸­ï¼Œå­¦ä¹ äº†å°†é€è§†åº”ç”¨åˆ°å•ä¸ªè§†å›¾åˆ¶ä½œå‡ºç®€å•çš„3Dæ•ˆæœçš„åŠ¨ç”»ï¼› äº‹å®ä¸Šï¼Œä¸€æ—¦æˆ‘ä»¬çŸ¥é“m34å’Œç›¸æœºè·ç¦»çš„ç§˜å¯†ï¼Œå°±å¯ä»¥åˆ›å»ºå„ç§3DåŠ¨ç”»ã€‚

æœ¬ç« ä»¥å‰é¢çš„å†…å®¹ä¸ºåŸºç¡€ï¼Œå­¦ä¹ å¦‚ä½•ä½¿ç”¨å¤šä¸ªè§†å›¾åˆ›å»ºæœ‰æ„æ€çš„3DåŠ¨ç”»ã€‚

æœ¬ç« çš„[å¼€å§‹é¡¹ç›®](README.md#å…³äºä»£ç ) ***ImageGallery***æ˜¯ä¸€ä¸ªç®€å•çš„é£“é£å›¾åº“ã€‚ 



### æ¢ç´¢å¼€å§‹é¡¹ç›®
æœ¬ç« çš„å¼€å§‹é¡¹ç›®æ˜¯ï¼š

![image-20181212190316969](https://ws2.sinaimg.cn/large/006tNbRwgy1fy461l43y4j307m083glg.jpg)

åªæ˜¯ä¸€ä¸ªç©ºç™½å±å¹•ï¼Œé¡¶éƒ¨æœ‰ä¸¤ä¸ªæŒ‰é’®ã€‚

æ‰“å¼€`ViewController.swift`ï¼Œä¼šçœ‹åˆ°ä¸€ä¸ªåä¸º`images`çš„æ•°ç»„ï¼Œæ­¤æ•°ç»„å°±æ˜¯ä¸€äº›å›¾ç‰‡ä¿¡æ¯ã€‚

 `ImagViewCard`ç±»ç»§æ‰¿è‡ª`UIImageView`å¹¶ä¸”æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å±æ€§`title`æ¥ä¿å­˜é£“é£æ ‡é¢˜ï¼Œæœ‰ä¸€ä¸ªåä¸º`didSelect`çš„å±æ€§ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥è½»æ¾åœ°åœ¨å›¾åƒä¸Šè®¾ç½®ç‚¹å‡»å¤„ç†ç¨‹åºã€‚



ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å°†æ‰€æœ‰å›¾åƒæ·»åŠ åˆ°è§†å›¾æ§åˆ¶å™¨çš„è§†å›¾ä¸­ã€‚ å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`viewDidAppeae(_:)`çš„æœ«å°¾ï¼š

```swift
for image in images {
    image.layer.anchorPoint.y = 0.0
    image.frame = view.bounds

    view.addSubview(image)
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¾ªç¯éå†æ‰€æœ‰å›¾åƒï¼Œåœ¨yè½´ä¸Šå°†æ¯ä¸ªå›¾åƒçš„é”šç‚¹è®¾ç½®ä¸º0.0ï¼Œå¹¶è°ƒæ•´æ¯ä¸ªå›¾åƒçš„å¤§å°ï¼Œä½¿å…¶å æ®æ•´ä¸ªå±å¹•ã€‚ è®¾ç½®é”šç‚¹å¯è®©å›¾åƒå›´ç»•å…¶ä¸Šè¾¹ç¼˜è€Œä¸æ˜¯ä¸­å¿ƒçš„é»˜è®¤å€¼æ—‹è½¬ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20181205113638430](https://ws1.sinaimg.cn/large/006tNbRwgy1fxvpsq3ekwj30d7068417.jpg)

è¿è¡Œåªä¼šçœ‹åˆ°æœ€åä¸€å¼ å›¾ç‰‡`Hurricane Irene`ï¼Œå› ä¸ºå›¾ç‰‡ä½ç½®ç›¸åŒï¼Œå åŠ åœ¨ä¸€èµ·æ¥

æ˜¾ç¤ºé£“é£å›¾åƒçš„åå­—ï¼Œåœ¨`viewDidAppear(_:)`çš„æœ«å°¾æ·»åŠ ä»¥ä¸‹è¡Œï¼š

```swift
navigationItem.title = images.last?.title
```



æ³¨æ„ï¼Œç›®å‰æ²¡æœ‰åœ¨å›¾åƒä¸Šè®¾ç½®ä»»ä½•é€è§†è½¬æ¢;ä¹‹åå°†ç›´æ¥åœ¨è§†å›¾æ§åˆ¶å™¨çš„è§†å›¾ä¸Šè®¾ç½®é€è§†å›¾ã€‚

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œåœ¨å•ä¸ªè§†å›¾ä¸Šè°ƒæ•´äº†`transfor`må±æ€§ï¼Œç„¶ååœ¨3Dç©ºé—´ä¸­æ—‹è½¬å®ƒã€‚ä½†æ˜¯ï¼Œç”±äºæ‚¨å½“å‰çš„é¡¹ç›®æœ‰æ›´å¤šçš„ä¸ªäººè§†å›¾ï¼Œéœ€è¦åœ¨3Dä¸­æ“ä½œï¼Œæ‚¨å¯ä»¥è®¾ç½®å…¶çˆ¶è§†å›¾çš„é€è§†å›¾ï¼Œä»è€ŒèŠ‚çœå¤§é‡å·¥ä½œã€‚

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`viewDidAppear(_:)`ï¼š

```swift
var perspective = CATransform3DIdentity
perspective.m34 = -1.0/250.0
view.layer.sublayerTransform = perspective
```

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å›¾å±‚å±æ€§`sublayerTransform`æ¥è®¾ç½®è§†å›¾æ§åˆ¶å™¨å›¾å±‚çš„æ‰€æœ‰å­å›¾å±‚çš„é€è§†å›¾ã€‚ ç„¶åå°†å­å±‚è½¬æ¢ä¸æ¯ä¸ªå•ç‹¬å±‚çš„è‡ªèº«å˜æ¢ç»„åˆã€‚

è¿™ä½¿æ‚¨å¯ä»¥ä¸“æ³¨äºç®¡ç†å­è§†å›¾çš„æ—‹è½¬æˆ–å¹³ç§»ï¼Œè€Œæ— éœ€æ‹…å¿ƒé€è§†ã€‚ æ‚¨å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ›´è¯¦ç»†åœ°äº†è§£å®ƒçš„å·¥ä½œåŸç†ã€‚

### æ”¹å˜å›¾åº“

`toggleGallery(_:)`è¿æ¥ç€å³ä¸Šæ–¹çš„â€œæµè§ˆâ€æŒ‰é’®ï¼Œåœ¨æ­¤å¤„å°†3Då˜æ¢åº”ç”¨äºå››ä¸ªå›¾åƒã€‚

å°†ä»¥ä¸‹å˜é‡æ·»åŠ åˆ°`toggleGallery(_:)`ï¼š

```swift
var imageYOffset: CGFloat = 50.0

for subview in view.subviews {
    guard let image = subview as? ImageViewCard else {
        continue
    }
}
```

ç”±äºæ‚¨ä¸åªæ˜¯å°†æ‰€æœ‰å›¾åƒæ—‹è½¬åˆ°åŸä½è€Œåªæ˜¯ç§»åŠ¨å®ƒä»¬ä»¥äº§ç”Ÿâ€æ‰‡å½¢â€œåŠ¨ç”»ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨`imageYOffset`æ¥è®¾ç½®æ¯ä¸ªå›¾åƒçš„åç§»ã€‚
æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦éå†æ‰€æœ‰å›¾åƒå¹¶è¿è¡Œå…¶å„è‡ªçš„åŠ¨ç”»ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¾ªç¯æµè§ˆè§†å›¾æ§åˆ¶å™¨è§†å›¾çš„æ‰€æœ‰å­è§†å›¾ï¼Œå¹¶ä»…å¯¹ä½œä¸º`ImageViewCard`å®ä¾‹çš„å­è§†å›¾æ‰§è¡Œæ“ä½œã€‚
åœ¨ä¸Šé¢æ·»åŠ çš„`guard`å—ä¹‹åæ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œä»¥æ›¿æ¢æ­¤å¤„çš„æ›´å¤šä»£ç æ³¨é‡Šï¼š

```swift
var imageTransform = CATransform3DIdentity
// 1
imageTransform = CATransform3DTranslate(imageTransform, 0.0, imageYOffset, 0.0)
// 2
imageTransform = CATransform3DScale(imageTransform, 0.95, 0.6, 1.0)
// 3
imageTransform = CATransform3DRotate(imageTransform, .pi/8, -1.0, 0.0, 0.0)
```

é¦–å…ˆå°†æ ‡è¯†è½¬æ¢åˆ†é…ç»™imageTransformï¼Œç„¶åå¯¹å…¶æ·»åŠ ä¸€ç³»åˆ—è°ƒæ•´ã€‚ è¿™æ˜¯æ¯ä¸ªå•ç‹¬çš„è°ƒæ•´å¯¹å›¾åƒçš„ä½œç”¨ï¼š

`// 1` ä½¿ç”¨`CATransform3DTranslate`åœ¨yè½´ä¸Šç§»åŠ¨å›¾åƒ; è¿™ä¼šä½¿å›¾åƒåç¦»å…¶é»˜è®¤çš„**0.0 yåæ ‡**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20181212182739840](https://ws2.sinaimg.cn/large/006tNbRwgy1fy450l67o1j30cj06a772.jpg)

ä¹‹åï¼Œå°†è¦åˆ†åˆ«è®¡ç®—æ¯ä¸ªå›¾åƒçš„`imageYOffset`ï¼Œå¦åˆ™å›¾ç‰‡è¿˜æ˜¯å åŠ åœ¨ä¸€èµ·ã€‚

`// 2` é€šè¿‡ä½¿ç”¨`CATransform3DScale`è°ƒæ•´è½¬æ¢çš„æ¯”ä¾‹åˆ†é‡æ¥ç¼©æ”¾å›¾åƒã€‚ å¯ä»¥åœ¨xè½´ä¸Šç¨å¾®ç¼©å°å›¾åƒï¼Œä½†æ˜¯åœ¨yè½´ä¸Šå°†å…¶ç¼©å°åˆ°60ï¼…ä»¥ä¸°å¯Œæ—‹è½¬3Dæ•ˆæœï¼š

![image-20181212182903109](https://ws3.sinaimg.cn/large/006tNbRwgy1fy451zjly0j30fy08p77t.jpg)

`// 3` æœ€åï¼Œä½¿ç”¨`CATransform3DRotate`å°†å›¾åƒæ—‹è½¬22.5åº¦ï¼Œä½¿å…¶å…·æœ‰ä¸€äº›é€è§†å˜å½¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20181212182944370](https://ws1.sinaimg.cn/large/006tNbRwgy1fy452p4h3vj30fg082dhq.jpg)

è¯·è®°ä½ï¼Œä¹‹å‰å·²ç»è®¾ç½®äº†é”šç‚¹ï¼Œå› æ­¤å›¾åƒå›´ç»•å…¶é¡¶éƒ¨è¾¹ç¼˜æ—‹è½¬ã€‚

ç°åœ¨ä½ çœ‹åˆ°é€šè¿‡view.layer.sublayerTransformè®¾ç½®ä¸Šé¢çš„m34å€¼çš„å€¼; æ‚¨çš„æ—‹è½¬å˜æ¢åªéœ€é‡æ–°ä½¿ç”¨å­å±‚å˜æ¢ä¸­çš„m34å€¼ï¼Œè€Œæ— éœ€åœ¨æ­¤å¤„åº”ç”¨å®ƒã€‚ é‚£å¾ˆæ–¹ä¾¿ï¼

ç°åœ¨å‰©ä¸‹çš„å°±æ˜¯å°†è½¬æ¢åº”ç”¨äºæ¯ä¸ªå›¾åƒã€‚ æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆä»åœ¨forä»£ç å—ä¸­ï¼‰ï¼š

```swift
image.layer.transform = imageTransform
```


å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ°forå—çš„æœ«å°¾ï¼Œä¿®æ”¹æ¯ä¸ªå›¾åƒçš„ä½ç½®ï¼š

```swift
imageYOffset += view.frame.height / CGFloat(images.count)
```

è¿™ä¼šè°ƒæ•´æ¯ä¸ªå›¾åƒçš„yåç§»é‡ï¼Œå…·ä½“å–å†³äºå®ƒåœ¨å †æ ˆä¸­çš„ä½ç½®ã€‚ å°†å±å¹•é«˜åº¦é™¤ä»¥å›¾åƒæ•°é‡ï¼Œä»¥ä¾¿å®ƒä»¬åœ¨å±å¹•ä¸Šå‡åŒ€åˆ†å¸ƒã€‚
è¿è¡Œåæ•ˆæœï¼š

![image-20181205115546758](https://ws2.sinaimg.cn/large/006tNbRwgy1fxvqcmw3j4j308w0fu0ym.jpg)

ä¸‹é¢è®©å®ƒåŠ¨èµ·æ¥ï¼

### åŠ¨ç”»å›¾åº“

åœ¨ä¸Šé¢çš„`image.layer.transform = imageTransform`çš„å‰é¢æ·»åŠ ï¼š

```swift
let animation = CABasicAnimation(keyPath: "transform")
animation.fromValue = NSValue(caTransform3D: image.layer.transform)
animation.toValue = NSValue(caTransform3D: imageTransform)
animation.duration = 0.33
image.layer.add(animation, forKey: nil)
```

è¿™æ®µä»£ç éå¸¸ç†Ÿæ‚‰ï¼šåœ¨transformå±æ€§ä¸Šåˆ›å»ºä¸€ä¸ªå›¾å±‚åŠ¨ç”»ï¼Œå¹¶å°†å…¶ä»å½“å‰å€¼è®¾ç½®ä¸ºä¹‹å‰è®¾è®¡çš„`imageTransform`ã€‚
è¿è¡Œåï¼Œ ç‚¹å‡»â€œæµè§ˆâ€æŒ‰é’®ï¼Œæ•ˆæœï¼š

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxvqjb5gwig308q0fo49f.gif)

ä½ ç°åœ¨å·²ç»å®Œæˆäº†ç”»å»Š; å½“æ‚¨åœ¨ç”¨æˆ·ç‚¹å‡»â€œæµè§ˆâ€æŒ‰é’®æ—¶æ·»åŠ å…³é—­é£æ‰‡çš„åŠŸèƒ½æ—¶ï¼Œæ‚¨å°†åœ¨â€œæŒ‘æˆ˜â€éƒ¨åˆ†é‡æ–°è®¿é—®å®ƒã€‚

### æ›´å¤šä¸€ç‚¹äº¤äº’

ä¸ºå›¾åƒåº“æ·»åŠ ä¸€ç‚¹äº¤äº’æ€§ï¼šç‚¹å‡»å›¾åƒï¼Œå˜æˆå…¨å±ï¼Œå¹¶ä¸”ä½ç½®ç§»åˆ°æœ€å‰é¢ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥æ›´å¥½åœ°æŸ¥çœ‹å®ƒã€‚

`ImageViewCard`å·²ç»å…·æœ‰åä¸º`didSelect`çš„é—­åŒ…è¡¨è¾¾å¼å±æ€§ï¼Œå½“ç”¨æˆ·ç‚¹å‡»å›¾åƒï¼Œå°±å°†ç‚¹å‡»çš„å›¾åƒè§†å›¾ä½œä¸ºè¾“å…¥å‚æ•°ç»™è¿™ä¸ªé—­åŒ…ã€‚

é¦–å…ˆå°†ä»¥ä¸‹ä»£ç æ·»åŠ `viewDidAppear()`çš„forå¾ªç¯ä½“å†…ï¼š

```swift
image.didSelect = selectImage
```

åœ¨`ViewController`ä¸­æ·»åŠ æ–¹æ³•ï¼š

```swift
func selectImage(selectedImage: ImageViewCard) {

    for subview in view.subviews {
        guard let image = subview as? ImageViewCard else {
            continue
        }
        if image === selectedImage {

        } else {

        }
    }
}
```



ç°åœ¨æ‚¨è¿˜éœ€è¦ä¸¤ä¸ªåŠ¨ç”»ï¼šä¸€ä¸ªç”¨äºä¸ºæ‰€é€‰å›¾åƒè®¾ç½®åŠ¨ç”»ï¼Œå¦ä¸€ä¸ªç”¨äºä¸ºå›¾åº“ä¸­çš„æ‰€æœ‰å…¶ä»–å›¾åƒè®¾ç½®åŠ¨ç”»ã€‚
ä½ å°†åè¿‡æ¥è§£å†³è¿™ä¸ªé—®é¢˜å¹¶é¦–å…ˆæ·¡å‡ºæœªé€‰æ‹©çš„å›¾åƒã€‚

ä¸Šé¢çš„æ–¹æ³•è¿˜ç¼ºå°‘ä¸¤ä¸ªåŠ¨ç”»ï¼Œå½“`image === selectedImage`ï¼Œå°±æ˜¯æ‰€é€‰å›¾åƒçš„åŠ¨ç”»ï¼›æˆ–è€…ï¼Œæœªé€‰æ‹©çš„æ‰€æœ‰å…¶ä»–å›¾åƒçš„åŠ¨ç”»ï¼Œå‰è€…ä»£ç ä¸ºï¼š

```swift
UIView.animate(withDuration: 0.33, delay: 0.0, options: .curveEaseIn, animations: {
    image.alpha = 0.0
}, completion: { (_) in
    image.alpha = 1.0
    image.layer.transform = CATransform3DIdentity
})
```

åè€…ä»£ç ä¸ºï¼š

```swift
UIView.animate(withDuration: 0.33, delay: 0.0, options: .curveEaseIn, animations: {
    image.layer.transform = CATransform3DIdentity
}, completion: {_ in
    self.view.bringSubview(toFront: image)
})
```

åœ¨è¿™é‡Œï¼Œæ²¡æœ‰å¯¹åŠ¨ç”»è¿›è¡Œ3Då˜æ¢ï¼Œç„¶åç¡®ä¿å›¾åƒä½äºè§†å›¾å †æ ˆçš„é¡¶éƒ¨ï¼Œä»¥ä¾¿å®ƒå¯è§ã€‚



æœ€åï¼Œå°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`selectImage(selectedImage:)`çš„æœ«å°¾ï¼Œæ›´æ–°æ ‡é¢˜ï¼š

```swift
self.navigationItem.title = selectedImage.title
```



### åˆ‡æ¢å›¾åº“

è¿™å°ç»“å·¥ä½œæ˜¯å°†ä½¿â€œæµè§ˆâ€æŒ‰é’®å¯ä»¥å…³é—­å›¾åº“è§†å›¾ã€‚

å‘`ViewController`æ·»åŠ ä¸€ä¸ª`isGalleryOpen`çš„æ–°å±æ€§ï¼Œå¹¶å°†å…¶åˆå§‹å€¼è®¾ç½®ä¸º`false`ã€‚ 

éœ€è¦åœ¨ä»£ç ä¸­çš„ä¸¤ä¸ªä½ç½®æ›´æ–°æ­¤å±æ€§çš„å€¼ï¼š

- åœ¨`toggleGallery(_:)`ç»“æŸæ—¶å°†å…¶è®¾ç½®ä¸º`true`
- åœ¨`selectImage(selectedImage:)`ç»“æŸæ—¶å°†å…¶è®¾ç½®ä¸º`false`



åœ¨`toggleGallery()`çš„é¡¶éƒ¨ï¼Œæ·»åŠ ä¸€ä¸ªæ£€æŸ¥ä»¥æŸ¥çœ‹å›¾åº“æ˜¯å¦å·²æ‰“å¼€ã€‚ å¦‚æœæ‰“å¼€ï¼Œåˆ™éå†æ‰€æœ‰å›¾åƒå¹¶å°†å…¶è½¬æ¢è®¾ç½®ä¸ºåŸå§‹å€¼ã€‚ ä¸è¦å¿˜è®°é‡ç½®`isGalleryOpen`å¹¶è¿”å›ï¼Œå› æ­¤å…¶ä½™çš„æ–¹æ³•ä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚

```swift
if isGalleryOpen {
    for subview in view.subviews {
        guard let image = subview as? ImageViewCard else {
            continue
        }

        let animation = CABasicAnimation(keyPath: "transform")
        animation.fromValue = NSValue(caTransform3D: image.layer.transform)
        animation.toValue = NSValue(caTransform3D: CATransform3DIdentity)
        animation.duration = 0.33

        image.layer.add(animation, forKey: nil)
        image.layer.transform = CATransform3DIdentity

    }

    isGalleryOpen = false
    return
}
```



æœ¬ç« çš„æœ€åæ•ˆæœï¼š

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxvr9roxswg308q0fo7wh.gif)